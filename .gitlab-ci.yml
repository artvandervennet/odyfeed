image: node:22

stages:
  - deploy

cache:
  key:
    files:
      - pnpm-lock.yaml
  paths:
    - node_modules/
    - .pnpm-store

before_script:
  - corepack enable
  - corepack prepare pnpm@latest-8 --activate
  - pnpm config set store-dir .pnpm-store
  - pnpm install

plesk:
  stage: deploy
  script:
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H cloudplesk.ikdoeict.be >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts

    - 'command -v ssh-agent >/dev/null || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - echo "Username is $SSH_USERNAME"
    - echo "$SSH_PRIVATE_KEY"
    - echo "$SSH_USERNAME"
    - chmod 400 "$SSH_PRIVATE_KEY"
    - ssh-add "$SSH_PRIVATE_KEY"

    - pnpm build

    - ssh -o StrictHostKeyChecking=no $SSH_USERNAME@cloudplesk.ikdoeict.be "rm -rf $PLESK_DIRECTORY/*"
    - scp -o StrictHostKeyChecking=no -r .output/. $SSH_USERNAME@cloudplesk.ikdoeict.be:$PLESK_DIRECTORY
  only:
    - main

